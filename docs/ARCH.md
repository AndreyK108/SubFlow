# ARCH — Архитектура SubFlow

## 1. Назначение системы
SubFlow — веб-система учёта подписок и сервисов для B2C и упрощённого B2B.
Ключевой экран: календарь списаний/окончаний/trial, события генерируются динамически из данных подписок.

## 2. Архитектурный стиль
Выбран стиль: модульный монолит с разделением на слои (Domain / Application / Infrastructure / Web).
Один деплой, единая БД, но строгие границы зависимостей между проектами.

Цели:
- простота разработки и сопровождения в рамках диплома;
- возможность расширять интеграции (Telegram) без переписывания ядра;
- тестируемость use-case логики без UI/БД.

## 3. Контекст (C4: System Context)
Участники:
- Пользователь (User) — ведёт подписки, календарь, отчёты, импорт/экспорт.
- Администратор (Admin) — управляет пользователями/пространством организации (упрощённый B2B).

Внешние системы:
- Telegram Bot API — канал уведомлений (опционально).
- Файлы Excel — импорт/экспорт (отчёты, массовая загрузка).

## 4. Контейнеры (C4: Containers)
1) Web-приложение (ASP.NET Core)
- UI (Razor Pages/MVC)
- Auth (cookie-based)
- API endpoints (если понадобится для динамики календаря/импорта)

2) База данных (SQL Server)
- хранит подписки, категории, события (по модели), напоминания, пользователей, токены Telegram.
- См. подробную ER-модель: docs/DB.md

## 5. Компоненты внутри Web-приложения
Слои/проекты:

### SubFlow.Domain
Содержит:
- доменные сущности (Subscription, Service, Category, Owner, License, Organization, UserProfile, Reminder)
- value objects (Money, DateRange, BillingPeriod и т.п.)
- доменные инварианты (например: дата окончания >= дата начала, сумма >= 0)

Не содержит:
- EF Core, контроллеров, HttpClient, логирования.

### SubFlow.Application
Содержит:
- use-cases (команды/запросы): CreateSubscription, UpdateSubscription, GenerateCalendarEvents, ExportReport, ImportFromExcel, BindTelegram
- DTO/модели представления для UI
- интерфейсы портов: ISubscriptionRepository, IReportExporter, IExcelImporter, INotificationSender, IClock

### SubFlow.Infrastructure
Содержит:
- EF Core DbContext + миграции
- реализации репозиториев
- реализацию Excel (ClosedXML)
- реализацию Telegram sender (HttpClient + Bot API)
- сервисы интеграции и адаптеры

### SubFlow.Web
Содержит:
- Razor Pages/MVC, валидация UI
- cookie-auth + роли Admin/User
- DI конфигурация
- endpoints для импорта/экспорта и экранов календаря/аналитики

## 6. Динамическая генерация событий календаря
Календарь строится на лету из данных подписок.
На период (например 3/6/12 месяцев) генерируются события:
- списание (billing date)
- окончание trial
- окончание подписки/лицензии
- напоминание за N дней до события

События могут:
- вычисляться на лету при запросе календаря;
- при необходимости кэшироваться (не обязательно для диплома).

## 7. Безопасность и роли
- Аутентификация: ASP.NET Core Identity + Cookie.
- Авторизация:
  - User — доступ к своим данным (или данным организации, если B2B-режим).
  - Admin — управление пользователями и общими справочниками организации.

## 8. Нефункциональные требования (минимум)
- Понятный UX: 1 экран = 1 задача.
- Отказоустойчивость: не критично (диплом), но ошибки интеграций не должны ломать UI.
- Логи: стандартный ILogger.
